{"version":3,"file":"wd-sticky-box.js","sources":["uni_modules/wot-design-uni/components/wd-sticky-box/wd-sticky-box.vue","D:/software/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/RjoveXVuc29vX21vYmlsZS91bmlfbW9kdWxlcy93b3QtZGVzaWduLXVuaS9jb21wb25lbnRzL3dkLXN0aWNreS1ib3gvd2Qtc3RpY2t5LWJveC52dWU"],"sourcesContent":["<template>\r\n  <view style=\"position: relative\">\r\n    <view :class=\"`wd-sticky-box ${props.customClass}`\" :style=\"customStyle\" :id=\"styckyBoxId\">\r\n      <wd-resize @resize=\"handleResize\">\r\n        <slot />\r\n      </wd-resize>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script lang=\"ts\">\r\nexport default {\r\n  name: 'wd-sticky-box',\r\n  options: {\r\n    addGlobalClass: true,\r\n    // virtualHost: true,\r\n    styleIsolation: 'shared'\r\n  }\r\n}\r\n</script>\r\n\r\n<script lang=\"ts\" setup>\r\nimport wdResize from '../wd-resize/wd-resize.vue'\r\nimport { getCurrentInstance, onBeforeMount, reactive, ref } from 'vue'\r\nimport { getRect, uuid } from '../common/util'\r\nimport { baseProps } from '../common/props'\r\nimport { STICKY_BOX_KEY } from './types'\r\nimport { useChildren } from '../composables/useChildren'\r\n\r\nconst props = defineProps(baseProps)\r\n\r\nconst styckyBoxId = ref<string>(`wd-sticky-box${uuid()}`)\r\n\r\nconst observerMap = ref<Map<any, any>>(new Map())\r\n\r\nconst boxStyle = reactive({\r\n  height: 0,\r\n  width: 0\r\n})\r\n\r\nconst { proxy } = getCurrentInstance() as any\r\n\r\nconst { children: stickyList, linkChildren } = useChildren(STICKY_BOX_KEY)\r\nlinkChildren({\r\n  boxStyle: boxStyle,\r\n  observerForChild\r\n})\r\n\r\nonBeforeMount(() => {\r\n  observerMap.value = new Map()\r\n})\r\n\r\n/**\r\n * 容器大小变化后重新监听sticky组件与box组件的交叉状态\r\n * @param detail\r\n */\r\nfunction handleResize(detail: any) {\r\n  // 相对的容器大小改变后，同步设置 wd-sticky-box 的大小\r\n  boxStyle.width = detail.width\r\n  boxStyle.height = detail.height\r\n  // wd-sticky-box 大小变化时，重新监听所有吸顶元素\r\n  const temp = observerMap.value\r\n  observerMap.value = new Map()\r\n  for (const [uid] of temp) {\r\n    const child = stickyList.find((sticky) => {\r\n      return sticky.$.uid === uid\r\n    })\r\n    observerForChild(child)\r\n  }\r\n  temp.forEach((observer) => {\r\n    observer.disconnect()\r\n  })\r\n  temp.clear()\r\n}\r\n/**\r\n * 删除对指定sticky的监听\r\n * @param child 指定的子组件\r\n */\r\nfunction deleteObserver(child: any) {\r\n  const observer = observerMap.value.get(child.$.uid)\r\n  if (!observer) return\r\n  observer.disconnect()\r\n  observerMap.value.delete(child.$.uid)\r\n}\r\n/**\r\n * 针对指定sticky添加监听\r\n * @param child 指定的子组件\r\n */\r\nfunction createObserver(child: any) {\r\n  const observer = uni.createIntersectionObserver(proxy, { thresholds: [0, 0.5] })\r\n  observerMap.value.set(child.$.uid, observer)\r\n  return observer\r\n}\r\n/**\r\n * 监听子组件\r\n * @param child 子组件\r\n */\r\nfunction observerForChild(child: any) {\r\n  deleteObserver(child)\r\n  const observer = createObserver(child)\r\n  const exposed = child.$.exposed\r\n  let offset = exposed.stickyState.height + exposed.offsetTop\r\n\r\n\r\n\r\n\r\n\r\n\r\n  if (boxStyle.height <= exposed.stickyState.height) {\r\n    exposed.setPosition(false, 'absolute', 0)\r\n  }\r\n  observer.relativeToViewport({ top: -offset }).observe(`#${styckyBoxId.value}`, (result) => {\r\n    handleRelativeTo(exposed, result)\r\n  })\r\n  // 当子组件默认处于边界外且永远不会进入边界内时，需要手动调用一次\r\n  getRect(`#${styckyBoxId.value}`, false, proxy)\r\n    .then((res) => {\r\n\r\n\r\n\r\n\r\n      if (Number(res.bottom) <= offset) handleRelativeTo(exposed, { boundingClientRect: res })\r\n    })\r\n    .catch((res) => {\r\n      uni.__f__('log','at uni_modules/wot-design-uni/components/wd-sticky-box/wd-sticky-box.vue:125',res)\r\n    })\r\n}\r\n/**\r\n *  监听容器组件\r\n * @param {Object} exposed wd-sticky实例暴露出的事件\r\n * @param {Object} boundingClientRect 边界信息\r\n */\r\nfunction handleRelativeTo(exposed: any, { boundingClientRect }: any) {\r\n  let childOffsetTop = exposed.offsetTop\r\n\r\n\r\n\r\n\r\n\r\n  const offset = exposed.stickyState.height + childOffsetTop\r\n  let isAbsolute = boundingClientRect.bottom <= offset\r\n\r\n\r\n\r\n  if (isAbsolute) {\r\n    exposed.setPosition(true, 'absolute', boundingClientRect.height - exposed.stickyState.height)\r\n  } else if (boundingClientRect.top <= offset && !isAbsolute) {\r\n    if (exposed.stickyState.state === 'normal') return\r\n    exposed.setPosition(false, 'fixed', childOffsetTop)\r\n  }\r\n}\r\n</script>\r\n<style lang=\"scss\" scoped>\r\n@import './index.scss';\r\n</style>\r\n","import Component from 'F:/yunsoo_mobile/uni_modules/wot-design-uni/components/wd-sticky-box/wd-sticky-box.vue'\nwx.createComponent(Component)"],"names":["ref","uuid","reactive","getCurrentInstance","useChildren","STICKY_BOX_KEY","onBeforeMount","uni","getRect"],"mappings":"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"}