{"version":3,"file":"useChildren.js","sources":["uni_modules/wot-design-uni/components/composables/useChildren.ts"],"sourcesContent":["import {\r\n  provide,\r\n  reactive,\r\n  getCurrentInstance,\r\n  type VNode,\r\n  type InjectionKey,\r\n  type VNodeNormalizedChildren,\r\n  type ComponentPublicInstance,\r\n  type ComponentInternalInstance\r\n} from 'vue'\r\n\r\n// 小程序端不支持从vue导出的isVNode方法，参考uni-mp-vue的实现\r\nfunction isVNode(value: any): value is VNode {\r\n  return value ? value.__v_isVNode === true : false\r\n}\r\n\r\nexport function flattenVNodes(children: VNodeNormalizedChildren) {\r\n  const result: VNode[] = []\r\n\r\n  const traverse = (children: VNodeNormalizedChildren) => {\r\n    if (Array.isArray(children)) {\r\n      children.forEach((child) => {\r\n        if (isVNode(child)) {\r\n          result.push(child)\r\n\r\n          if (child.component?.subTree) {\r\n            result.push(child.component.subTree)\r\n            traverse(child.component.subTree.children)\r\n          }\r\n\r\n          if (child.children) {\r\n            traverse(child.children)\r\n          }\r\n        }\r\n      })\r\n    }\r\n  }\r\n\r\n  traverse(children)\r\n\r\n  return result\r\n}\r\n\r\nconst findVNodeIndex = (vnodes: VNode[], vnode: VNode) => {\r\n  const index = vnodes.indexOf(vnode)\r\n  if (index === -1) {\r\n    return vnodes.findIndex((item) => vnode.key !== undefined && vnode.key !== null && item.type === vnode.type && item.key === vnode.key)\r\n  }\r\n  return index\r\n}\r\n\r\n// sort children instances by vnodes order\r\nexport function sortChildren(\r\n  parent: ComponentInternalInstance,\r\n  publicChildren: ComponentPublicInstance[],\r\n  internalChildren: ComponentInternalInstance[]\r\n) {\r\n  const vnodes = parent && parent.subTree && parent.subTree.children ? flattenVNodes(parent.subTree.children) : []\r\n\r\n  internalChildren.sort((a, b) => findVNodeIndex(vnodes, a.vnode) - findVNodeIndex(vnodes, b.vnode))\r\n\r\n  const orderedPublicChildren = internalChildren.map((item) => item.proxy!)\r\n\r\n  publicChildren.sort((a, b) => {\r\n    const indexA = orderedPublicChildren.indexOf(a)\r\n    const indexB = orderedPublicChildren.indexOf(b)\r\n    return indexA - indexB\r\n  })\r\n}\r\n\r\nexport function useChildren<\r\n  // eslint-disable-next-line\r\n  Child extends ComponentPublicInstance = ComponentPublicInstance<{}, any>,\r\n  ProvideValue = never\r\n>(key: InjectionKey<ProvideValue>) {\r\n  const publicChildren: Child[] = reactive([])\r\n  const internalChildren: ComponentInternalInstance[] = reactive([])\r\n  const parent = getCurrentInstance()!\r\n\r\n  const linkChildren = (value?: ProvideValue) => {\r\n    const link = (child: ComponentInternalInstance) => {\r\n      if (child.proxy) {\r\n        internalChildren.push(child)\r\n        publicChildren.push(child.proxy as Child)\r\n        sortChildren(parent, publicChildren, internalChildren)\r\n      }\r\n    }\r\n\r\n    const unlink = (child: ComponentInternalInstance) => {\r\n      const index = internalChildren.indexOf(child)\r\n      publicChildren.splice(index, 1)\r\n      internalChildren.splice(index, 1)\r\n    }\r\n\r\n    provide(\r\n      key,\r\n      Object.assign(\r\n        {\r\n          link,\r\n          unlink,\r\n          children: publicChildren,\r\n          internalChildren\r\n        },\r\n        value\r\n      )\r\n    )\r\n  }\r\n\r\n  return {\r\n    children: publicChildren,\r\n    linkChildren\r\n  }\r\n}\r\n"],"names":["children","reactive","getCurrentInstance","provide"],"mappings":";;AAYA,SAAS,QAAQ,OAA4B;AACpC,SAAA,QAAQ,MAAM,gBAAgB,OAAO;AAC9C;AAEO,SAAS,cAAc,UAAmC;AAC/D,QAAM,SAAkB,CAAA;AAElB,QAAA,WAAW,CAACA,cAAsC;AAClD,QAAA,MAAM,QAAQA,SAAQ,GAAG;AAC3BA,gBAAS,QAAQ,CAAC,UAAU;;AACtB,YAAA,QAAQ,KAAK,GAAG;AAClB,iBAAO,KAAK,KAAK;AAEb,eAAA,WAAM,cAAN,mBAAiB,SAAS;AACrB,mBAAA,KAAK,MAAM,UAAU,OAAO;AAC1B,qBAAA,MAAM,UAAU,QAAQ,QAAQ;AAAA,UAC3C;AAEA,cAAI,MAAM,UAAU;AAClB,qBAAS,MAAM,QAAQ;AAAA,UACzB;AAAA,QACF;AAAA,MAAA,CACD;AAAA,IACH;AAAA,EAAA;AAGF,WAAS,QAAQ;AAEV,SAAA;AACT;AAEA,MAAM,iBAAiB,CAAC,QAAiB,UAAiB;AAClD,QAAA,QAAQ,OAAO,QAAQ,KAAK;AAClC,MAAI,UAAU,IAAI;AAChB,WAAO,OAAO,UAAU,CAAC,SAAS,MAAM,QAAQ,UAAa,MAAM,QAAQ,QAAQ,KAAK,SAAS,MAAM,QAAQ,KAAK,QAAQ,MAAM,GAAG;AAAA,EACvI;AACO,SAAA;AACT;AAGgB,SAAA,aACd,QACA,gBACA,kBACA;AACA,QAAM,SAAS,UAAU,OAAO,WAAW,OAAO,QAAQ,WAAW,cAAc,OAAO,QAAQ,QAAQ,IAAI,CAAA;AAE9G,mBAAiB,KAAK,CAAC,GAAG,MAAM,eAAe,QAAQ,EAAE,KAAK,IAAI,eAAe,QAAQ,EAAE,KAAK,CAAC;AAEjG,QAAM,wBAAwB,iBAAiB,IAAI,CAAC,SAAS,KAAK,KAAM;AAEzD,iBAAA,KAAK,CAAC,GAAG,MAAM;AACtB,UAAA,SAAS,sBAAsB,QAAQ,CAAC;AACxC,UAAA,SAAS,sBAAsB,QAAQ,CAAC;AAC9C,WAAO,SAAS;AAAA,EAAA,CACjB;AACH;AAEO,SAAS,YAId,KAAiC;AAC3B,QAAA,iBAA0BC,uBAAS,CAAA,CAAE;AACrC,QAAA,mBAAgDA,uBAAS,CAAA,CAAE;AACjE,QAAM,SAASC,cAAAA;AAET,QAAA,eAAe,CAAC,UAAyB;AACvC,UAAA,OAAO,CAAC,UAAqC;AACjD,UAAI,MAAM,OAAO;AACf,yBAAiB,KAAK,KAAK;AACZ,uBAAA,KAAK,MAAM,KAAc;AAC3B,qBAAA,QAAQ,gBAAgB,gBAAgB;AAAA,MACvD;AAAA,IAAA;AAGI,UAAA,SAAS,CAAC,UAAqC;AAC7C,YAAA,QAAQ,iBAAiB,QAAQ,KAAK;AAC7B,qBAAA,OAAO,OAAO,CAAC;AACb,uBAAA,OAAO,OAAO,CAAC;AAAA,IAAA;AAGlCC,kBAAA;AAAA,MACE;AAAA,MACA,OAAO;AAAA,QACL;AAAA,UACE;AAAA,UACA;AAAA,UACA,UAAU;AAAA,UACV;AAAA,QACF;AAAA,QACA;AAAA,MACF;AAAA,IAAA;AAAA,EACF;AAGK,SAAA;AAAA,IACL,UAAU;AAAA,IACV;AAAA,EAAA;AAEJ;;"}