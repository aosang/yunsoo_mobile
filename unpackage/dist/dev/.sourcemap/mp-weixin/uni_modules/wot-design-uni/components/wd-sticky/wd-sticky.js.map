{"version":3,"file":"wd-sticky.js","sources":["uni_modules/wot-design-uni/components/wd-sticky/wd-sticky.vue","D:/software/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/RjoveXVuc29vX21vYmlsZS91bmlfbW9kdWxlcy93b3QtZGVzaWduLXVuaS9jb21wb25lbnRzL3dkLXN0aWNreS93ZC1zdGlja3kudnVl"],"sourcesContent":["<template>\r\n  <view :style=\"`${rootStyle};display: inline-block;`\">\r\n    <view :class=\"`wd-sticky ${customClass}`\" :style=\"stickyStyle\" :id=\"styckyId\">\r\n      <view class=\"wd-sticky__container\" :style=\"containerStyle\">\r\n        <wd-resize @resize=\"handleResize\" custom-style=\"display: inline-block;\">\r\n          <slot />\r\n        </wd-resize>\r\n      </view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script lang=\"ts\">\r\nexport default {\r\n  name: 'wd-sticky',\r\n  options: {\r\n    addGlobalClass: true,\r\n    virtualHost: true,\r\n    styleIsolation: 'shared'\r\n  }\r\n}\r\n</script>\r\n\r\n<script lang=\"ts\" setup>\r\nimport wdResize from '../wd-resize/wd-resize.vue'\r\nimport { computed, getCurrentInstance, reactive, ref, type CSSProperties } from 'vue'\r\nimport { addUnit, getRect, objToStyle, pause, uuid } from '../common/util'\r\nimport { stickyProps } from './types'\r\nimport { useParent } from '../composables/useParent'\r\nimport { STICKY_BOX_KEY } from '../wd-sticky-box/types'\r\n\r\nconst props = defineProps(stickyProps)\r\nconst styckyId = ref<string>(`wd-sticky${uuid()}`)\r\nconst observerList = ref<UniApp.IntersectionObserver[]>([])\r\n\r\nconst stickyState = reactive({\r\n  position: 'absolute',\r\n  boxLeaved: false,\r\n  top: 0,\r\n  height: 0,\r\n  width: 0,\r\n  state: ''\r\n})\r\n\r\nconst { parent: stickyBox } = useParent(STICKY_BOX_KEY)\r\n\r\nconst { proxy } = getCurrentInstance() as any\r\n\r\nconst rootStyle = computed(() => {\r\n  const style: CSSProperties = {\r\n    'z-index': props.zIndex,\r\n    height: addUnit(stickyState.height),\r\n    width: addUnit(stickyState.width)\r\n  }\r\n  if (!stickyState.boxLeaved) {\r\n    style['position'] = 'relative'\r\n  }\r\n  return `${objToStyle(style)}${props.customStyle}`\r\n})\r\n\r\nconst stickyStyle = computed(() => {\r\n  const style: CSSProperties = {\r\n    'z-index': props.zIndex,\r\n    height: addUnit(stickyState.height),\r\n    width: addUnit(stickyState.width)\r\n  }\r\n  if (!stickyState.boxLeaved) {\r\n    style['position'] = 'relative'\r\n  }\r\n  return `${objToStyle(style)}`\r\n})\r\n\r\nconst containerStyle = computed(() => {\r\n  const style: CSSProperties = {\r\n    position: stickyState.position as 'static' | 'relative' | 'absolute' | 'sticky' | 'fixed',\r\n    top: addUnit(stickyState.top)\r\n  }\r\n  return objToStyle(style)\r\n})\r\n\r\nconst innerOffsetTop = computed(() => {\r\n  let top: number = 0\r\n\r\n\r\n\r\n\r\n\r\n\r\n  return top + props.offsetTop\r\n})\r\n\r\n/**\r\n * 清除对当前组件的监听\r\n */\r\nfunction clearObserver() {\r\n  while (observerList.value.length !== 0) {\r\n    observerList.value.pop()!.disconnect()\r\n  }\r\n}\r\n/**\r\n * 添加对当前组件的监听\r\n */\r\nfunction createObserver() {\r\n  const observer = uni.createIntersectionObserver(proxy, { thresholds: [0, 0.5] })\r\n  observerList.value.push(observer)\r\n  return observer\r\n}\r\n/**\r\n *  当前内容高度发生变化时重置监听\r\n */\r\nasync function handleResize(detail: any) {\r\n  stickyState.width = detail.width\r\n  stickyState.height = detail.height\r\n  await pause()\r\n  observerContentScroll()\r\n  if (!stickyBox || !stickyBox.observerForChild) return\r\n  stickyBox.observerForChild(proxy)\r\n}\r\n/**\r\n *  监听吸顶元素滚动事件\r\n */\r\nfunction observerContentScroll() {\r\n  if (stickyState.height === 0 && stickyState.width === 0) return\r\n  const offset = innerOffsetTop.value + stickyState.height\r\n  clearObserver()\r\n  createObserver()\r\n    .relativeToViewport({\r\n      top: -offset\r\n    })\r\n    .observe(`#${styckyId.value}`, (result) => {\r\n      handleRelativeTo(result)\r\n    })\r\n  getRect(`#${styckyId.value}`, false, proxy).then((res) => {\r\n\r\n\r\n\r\n\r\n    if (Number(res.bottom) <= offset) handleRelativeTo({ boundingClientRect: res })\r\n  })\r\n}\r\n/**\r\n * @description 根据位置进行吸顶\r\n */\r\nfunction handleRelativeTo({ boundingClientRect }: any) {\r\n  // sticky 高度大于或等于 wd-sticky-box，使用 wd-sticky-box 无任何意义\r\n  if (stickyBox && stickyBox.boxStyle && stickyState.height >= stickyBox.boxStyle.height) {\r\n    stickyState.position = 'absolute'\r\n    stickyState.top = 0\r\n    return\r\n  }\r\n\r\n  let isStycky = boundingClientRect.top <= innerOffsetTop.value\r\n\r\n\r\n\r\n\r\n  if (isStycky) {\r\n    stickyState.state = 'sticky'\r\n    stickyState.boxLeaved = false\r\n    stickyState.position = 'fixed'\r\n    stickyState.top = innerOffsetTop.value\r\n  } else {\r\n    stickyState.state = 'normal'\r\n    stickyState.boxLeaved = false\r\n    stickyState.position = 'absolute'\r\n    stickyState.top = 0\r\n  }\r\n}\r\n\r\n/**\r\n * 设置位置\r\n * @param setboxLeaved\r\n * @param setPosition\r\n * @param setTop\r\n */\r\nfunction setPosition(boxLeaved: boolean, position: string, top: number) {\r\n  stickyState.boxLeaved = boxLeaved\r\n  stickyState.position = position\r\n  stickyState.top = top\r\n}\r\n\r\ndefineExpose({\r\n  setPosition,\r\n  stickyState,\r\n  offsetTop: props.offsetTop\r\n})\r\n</script>\r\n<style lang=\"scss\" scoped>\r\n@import './index.scss';\r\n</style>\r\n","import Component from 'F:/yunsoo_mobile/uni_modules/wot-design-uni/components/wd-sticky/wd-sticky.vue'\nwx.createComponent(Component)"],"names":["ref","uuid","reactive","useParent","STICKY_BOX_KEY","getCurrentInstance","computed","addUnit","objToStyle","uni","pause","getRect"],"mappings":"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"}